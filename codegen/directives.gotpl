{{ $shouldGenerateRegularFunctions := .Config.GenerateRegularFunctions }}

{{ define "implDirectives" }}
	{{ $in := .Data.DirectiveObjName }}
	{{ $shouldGenerateRegularFunctions := .ShouldGenerateRegularFunctions }}
	{{ $zeroVal := .Data.TypeReference.GO | ref}}
	{{- range $i, $directive := .Data.ImplDirectives -}}
		directive{{add $i 1}} := func(ctx context.Context) (interface{}, error) {
			{{- range $arg := $directive.Args }}
				{{- if notNil "Value" $arg }}
						{{ if $shouldGenerateRegularFunctions -}}
						{{ $arg.VarName }}, err := {{ $arg.TypeReference.UnmarshalFunc }}(ctx, ec, {{ $arg.Value | dump }})
						{{- else -}}
						{{ $arg.VarName }}, err := ec.{{ $arg.TypeReference.UnmarshalFunc }}(ctx, {{ $arg.Value | dump }})
						{{- end }}
						if err != nil{
							var zeroVal {{$zeroVal}}
							return zeroVal, err
						}
					{{- else if notNil "Default" $arg }}
						{{ if $shouldGenerateRegularFunctions -}}
						{{ $arg.VarName }}, err := {{ $arg.TypeReference.UnmarshalFunc }}(ctx, ec, {{ $arg.Default | dump }})
						{{- else -}}
						{{ $arg.VarName }}, err := ec.{{ $arg.TypeReference.UnmarshalFunc }}(ctx, {{ $arg.Default | dump }})
						{{- end }}
						if err != nil{
							var zeroVal {{$zeroVal}}
							return zeroVal, err
						}
					{{- end }}
			{{- end }}
			{{- if not $directive.IsBuiltIn}}
				if {{$directive.CallPath}} == nil {
					var zeroVal {{$zeroVal}}
					return zeroVal, errors.New("directive {{$directive.Name}} is not implemented")
				}
			{{- end}}
			return {{$directive.CallPath}}({{$directive.ResolveArgs $in $i }})
		}
	{{ end -}}
{{ end }}

{{define "queryDirectives"}}
	{{ $shouldGenerateRegularFunctions := .ShouldGenerateRegularFunctions }}
	for _, d := range obj.Directives {
		switch d.Name {
		{{- range $directive := .Data }}
		case "{{$directive.Name}}":
			{{- if $directive.Args }}
				rawArgs := d.ArgumentMap(ec.Variables)
				{{ if $shouldGenerateRegularFunctions -}}
				args, err := {{ $directive.ArgsFunc }}(ctx,ec,rawArgs)
				{{- else -}}
				args, err := ec.{{ $directive.ArgsFunc }}(ctx,rawArgs)
				{{- end }}
				if err != nil {
					ec.Error(ctx, err)
					return graphql.Null
				}
			{{- end }}
			n := next
			next = func(ctx context.Context) (interface{}, error) {
				{{- template "callDirective" $directive -}}
			}
		{{- end }}
		}
	}
	tmp, err := next(ctx)
	if err != nil {
		ec.Error(ctx, err)
		return graphql.Null
	}
	if data, ok := tmp.(graphql.Marshaler); ok {
		return data
	}
	ec.Errorf(ctx, `unexpected type %T from directive, should be graphql.Marshaler`, tmp)
	return graphql.Null
{{end}}

{{define "callDirective"}}
	{{- if not .IsBuiltIn}}
		if {{.CallPath}} == nil {
			return nil, errors.New("directive {{.Name}} is not implemented")
		}
	{{- end}}
	return {{.CallPath}}({{.CallArgs}})
{{end}}

{{ if .Directives.LocationDirectives "QUERY" }}
{{ if $shouldGenerateRegularFunctions -}}
func _queryMiddleware(ctx context.Context, ec *executionContext, obj *ast.OperationDefinition, next func(ctx context.Context) (interface{}, error)) graphql.Marshaler {
{{- else -}}
func (ec *executionContext) _queryMiddleware(ctx context.Context, obj *ast.OperationDefinition, next func(ctx context.Context) (interface{}, error)) graphql.Marshaler {
{{- end }}
	{{ template "queryDirectives" (dict "Data" .Directives.LocationDirectives "Type" "QUERY" "ShouldGenerateRegularFunctions" $shouldGenerateRegularFunctions) }}
}
{{ end }}

{{ if .Directives.LocationDirectives "MUTATION" }}
{{ if $shouldGenerateRegularFunctions -}}
func _mutationMiddleware(ctx context.Context, ec *executionContext, obj *ast.OperationDefinition, next func(ctx context.Context) (interface{}, error)) graphql.Marshaler {
{{- else -}}
func (ec *executionContext) _mutationMiddleware(ctx context.Context, obj *ast.OperationDefinition, next func(ctx context.Context) (interface{}, error)) graphql.Marshaler {
{{- end }}
	{{ template "queryDirectives" (dict "Data" .Directives.LocationDirectives "Type" "MUTATION" "ShouldGenerateRegularFunctions" $shouldGenerateRegularFunctions) }}
}
{{ end }}

{{ if .Directives.LocationDirectives "SUBSCRIPTION" }}
{{ if $shouldGenerateRegularFunctions -}}
func _subscriptionMiddleware(ctx context.Context, ec *executionContext, obj *ast.OperationDefinition, next func(ctx context.Context) (interface{}, error)) func(ctx context.Context) graphql.Marshaler {
{{- else -}}
func (ec *executionContext) _subscriptionMiddleware(ctx context.Context, obj *ast.OperationDefinition, next func(ctx context.Context) (interface{}, error)) func(ctx context.Context) graphql.Marshaler {
{{- end }}
	for _, d := range obj.Directives {
		switch d.Name {
		{{- range $directive := .Directives.LocationDirectives "SUBSCRIPTION" }}
		case "{{$directive.Name}}":
			{{- if $directive.Args }}
				rawArgs := d.ArgumentMap(ec.Variables)
				{{ if $shouldGenerateRegularFunctions -}}
				args, err := {{ $directive.ArgsFunc }}(ctx,ec,rawArgs)
				{{- else -}}
				args, err := ec.{{ $directive.ArgsFunc }}(ctx,rawArgs)
				{{- end }}
				if err != nil {
					ec.Error(ctx, err)
					return func(ctx context.Context) graphql.Marshaler {
						return graphql.Null
					}
				}
			{{- end }}
			n := next
			next = func(ctx context.Context) (interface{}, error) {
				{{- template "callDirective" $directive -}}
			}
		{{- end }}
		}
	}
	tmp, err := next(ctx)
	if err != nil {
		ec.Error(ctx, err)
		return func(ctx context.Context) graphql.Marshaler {
			return graphql.Null
		}
	}
	if data, ok := tmp.(func(ctx context.Context) graphql.Marshaler); ok {
		return data
	}
	ec.Errorf(ctx, `unexpected type %T from directive, should be graphql.Marshaler`, tmp)
	return func(ctx context.Context) graphql.Marshaler {
		return graphql.Null
	}
}
{{ end }}

{{ if .Directives.LocationDirectives "FIELD" }}
	{{ if $shouldGenerateRegularFunctions -}}
	func _fieldMiddleware(ctx context.Context, ec *executionContext, obj interface{}, next graphql.Resolver) interface{} {
	{{- else -}}
	func (ec *executionContext) _fieldMiddleware(ctx context.Context, obj interface{}, next graphql.Resolver) interface{} {
	{{- end }}
		{{- if .Directives.LocationDirectives "FIELD" }}
		fc := graphql.GetFieldContext(ctx)
		for _, d := range fc.Field.Directives {
			switch d.Name {
			{{- range $directive := .Directives.LocationDirectives "FIELD" }}
			case "{{$directive.Name}}":
				{{- if $directive.Args }}
					rawArgs := d.ArgumentMap(ec.Variables)
					{{ if $shouldGenerateRegularFunctions -}}
					args, err := {{ $directive.ArgsFunc }}(ctx,ec,rawArgs)
					{{- else -}}
					args, err := ec.{{ $directive.ArgsFunc }}(ctx,rawArgs)
					{{- end }}
					if err != nil {
						ec.Error(ctx, err)
						return nil
					}
				{{- end }}
				n := next
				next = func(ctx context.Context) (interface{}, error) {
					{{- template "callDirective" $directive -}}
				}
			{{- end }}
			}
		}
		{{- end }}
		res, err := ec.ResolverMiddleware(ctx, next)
		if err != nil {
			ec.Error(ctx, err)
			return nil
		}
		return res
	}
{{ end }}
